RELATIE TUSSEN QUERYAST EN EXPRESSIONAST

De ExpressionParser (Perspectives.Parsing.Arc.Expression) produceert de datastructuren Step en Assignment (Perspectives.Parsing.Arc.Expression.AST).

Het data-element SimpleStep heeft dezelfde betekenis als ElementaryQueryStep (Perspectives.QueryAST).

data SimpleStep =
  ArcIdentifier ArcPosition String
  | Binding ArcPosition
  | Binder ArcPosition
  | Context ArcPosition
  | Extern ArcPosition

data ElementaryQueryStep
  = QualifiedRole String
  | UnqualifiedRole String
  | QualifiedProperty String
  | UnqualifiedProperty String
  | QualifiedExternalProperty String
  | UnqualifiedExternalProperty String
  | Binding
  | Context
  | ExternalRole

De Constructors QualifiedRole, UnqualifiedRole, QualifiedProperty, UnqualifiedProperty, QualifiedExternalProperty en UnqualifiedExternalProperty van ElementaryQueryStep vallen allemaal onder de constructor SimpleStep.ArcIdentifier. 'Binder' zouden we moeten toevoegen aan ElementaryQueryStep om hem volledig te maken.

Op vergelijkbare wijze omvat BinaryStep van Arc.Expression, QueryStep van QueryAST.

data QueryStep
  = Compose QueryStep QueryStep
  | Terminal ElementaryQueryStep
  | Filter QueryStep QueryStep
  | Disjunction QueryStep QueryStep
  | Conjunction QueryStep QueryStep

newtype BinaryStep = BinaryStep {start :: ArcPosition, end :: ArcPosition, operator :: Operator, left :: Step, right :: Step}

data Operator =
  Compose ArcPosition
  | Equals ArcPosition
  | NotEquals ArcPosition
  | LessThen ArcPosition
  | LessThenEqual ArcPosition
  | GreaterThen ArcPosition
  | GreaterThenEqual ArcPosition
  | LogicalAnd ArcPosition
  | LogicalOr ArcPosition
  | Add ArcPosition
  | Subtract ArcPosition
  | Divide ArcPosition
  | Multiply ArcPosition
  | Filter ArcPosition

Arc.Expression omvat QueryAST: de eerste dekt meer gevallen dan de tweede (met name assignment, veel meer operatoren en precedentie daarvan.

ONDERLINGE POSITIONERING
De ExpressionParser produceert een AST die dus een generalisatie is van de AST die Perspectives.Query.DescriptionCompiler omzet naar een QueryFunctionDescription.

AANPAK
* Laat de DescriptionCompiler werken met de Expression.AST.
* Breid de DescriptionCompiler uit voor de extra mogelijkheden van Expression.AST.

Als onderdeel daarvan zou het fijn zijn als het data-element CompilerMessage opgenomen werd in het data-element PerspectivesError.

data CompilerMessage =
  UnknownElementaryQueryStep
  | IncompatibleQueryArgument Domain ElementaryQueryStep
  | ContextHasNoRole (ADT ContextType) String
  | RoleHasNoProperty (ADT EnumeratedRoleType) String
  | RoleHasNoBinding (ADT EnumeratedRoleType)
  | IncompatibleDomainsForJunction Domain Domain

data PerspectivesError
  = DefaultPrototype ContextType ContextType
    | CyclicAspects ArcPosition ContextType
    | WrongRoleKind RoleType RoleKind RoleKind
    | MissingForUser ArcPosition String
    | MissingObject ArcPosition String
    | NotWellFormedName ArcPosition String
    | RoleMissingInContext ArcPosition String String
    | UnknownRole ArcPosition String
    | UnknownProperty ArcPosition String
    | UnknownView ArcPosition String
    | NotUniquelyIdentifying ArcPosition String (Array String)
    | Custom String
    
Als extra kunnen we de Constructors van CompilerMessage voorzien van ArcPosition.

WANNEER EXPRESSIES COMPILEREN?
1. Omdat ik van stap tot stap range en domein wil controleren, moet ik beschikken over het volledige model (ik moet alle identifiers kunnen herleiden tot rollen in context of properties bij een rol).
2. Dat bereik ik pas in Phase3.
3. Daarom moet het type van calculation in CalculatedRole veranderen naar een Sum van de parse tree en de QueryFunctionDescription.