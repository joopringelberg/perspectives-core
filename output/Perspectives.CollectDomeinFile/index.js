// Generated by purs version 0.11.7
"use strict";
var Control_Applicative = require("../Control.Applicative");
var Control_Bind = require("../Control.Bind");
var Control_Monad_Aff = require("../Control.Monad.Aff");
var Control_Monad_Eff = require("../Control.Monad.Eff");
var Control_Monad_Reader_Trans = require("../Control.Monad.Reader.Trans");
var Control_Monad_State = require("../Control.Monad.State");
var Control_Monad_State_Class = require("../Control.Monad.State.Class");
var Control_Monad_State_Trans = require("../Control.Monad.State.Trans");
var Control_Monad_Trans_Class = require("../Control.Monad.Trans.Class");
var Control_Semigroupoid = require("../Control.Semigroupoid");
var Data_Eq = require("../Data.Eq");
var Data_Foldable = require("../Data.Foldable");
var Data_Function = require("../Data.Function");
var Data_Maybe = require("../Data.Maybe");
var Data_StrMap = require("../Data.StrMap");
var Data_Unit = require("../Data.Unit");
var Perspectives_ContextAndRole = require("../Perspectives.ContextAndRole");
var Perspectives_CoreTypes = require("../Perspectives.CoreTypes");
var Perspectives_DataTypeTripleGetters = require("../Perspectives.DataTypeTripleGetters");
var Perspectives_DomeinFile = require("../Perspectives.DomeinFile");
var Perspectives_Effects = require("../Perspectives.Effects");
var Perspectives_EntiteitAndRDFAliases = require("../Perspectives.EntiteitAndRDFAliases");
var Perspectives_Identifiers = require("../Perspectives.Identifiers");
var Perspectives_ModelBasedTripleGetters = require("../Perspectives.ModelBasedTripleGetters");
var Perspectives_PerspectEntiteit = require("../Perspectives.PerspectEntiteit");
var Perspectives_Resource = require("../Perspectives.Resource");
var Perspectives_ResourceRetrieval = require("../Perspectives.ResourceRetrieval");
var Perspectives_RunMonadPerspectivesQuery = require("../Perspectives.RunMonadPerspectivesQuery");
var Perspectives_Syntax = require("../Perspectives.Syntax");
var Prelude = require("../Prelude");
var domeinFileFromContext = function (enclosingContext) {
    var collect = function (c) {
        return function (definedAtToplevel) {
            var savedToCouchdb = function (ctxt) {
                return Data_Maybe.maybe(false)(Data_Function["const"](true))(Perspectives_ContextAndRole.context_rev(ctxt));
            };
            var recursiveCollect = function (subContextId) {
                return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff))(Perspectives_Resource.getPerspectEntiteit(Perspectives_PerspectEntiteit.perspectEntiteitContext)(subContextId)))(Data_Function.flip(collect)(Perspectives_ContextAndRole.context_id(c) === Perspectives_ContextAndRole.context_id(enclosingContext)));
            };
            var inDomeinFile = function (id) {
                return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Control_Monad_State_Class.get(Control_Monad_State_Trans.monadStateStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff))))(function (v) {
                    var v1 = Data_StrMap.lookup(id)(v.contexts);
                    if (v1 instanceof Data_Maybe.Just) {
                        return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(true);
                    };
                    if (v1 instanceof Data_Maybe.Nothing) {
                        var v2 = Data_StrMap.lookup(id)(v.roles);
                        if (v2 instanceof Data_Maybe.Just) {
                            return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(true);
                        };
                        return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(false);
                    };
                    throw new Error("Failed pattern match at Perspectives.CollectDomeinFile line 56, column 11 - line 60, column 38: " + [ v1.constructor.name ]);
                });
            };
            var saveContext = function (ctxt) {
                return function (definedAtToplevel$prime) {
                    var $14 = Perspectives_Identifiers.isInNamespace(Perspectives_ContextAndRole.context_id(ctxt))(Perspectives_ContextAndRole.context_id(enclosingContext));
                    if ($14) {
                        return Control_Bind.ifM(Control_Monad_State_Trans.bindStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(inDomeinFile(Perspectives_ContextAndRole.context_id(ctxt)))(Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(false))(Control_Bind.discard(Control_Bind.discardUnit)(Control_Monad_State_Trans.bindStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Control_Monad_State_Class.modify(Control_Monad_State_Trans.monadStateStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Perspectives_DomeinFile.addContextToDomeinFile(ctxt)))(function () {
                            return Control_Bind.discard(Control_Bind.discardUnit)(Control_Monad_State_Trans.bindStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff))(Perspectives_Resource.getPerspectEntiteit(Perspectives_PerspectEntiteit.perspectEntiteitRol)(Perspectives_ContextAndRole.context_buitenRol(ctxt))))(function ($21) {
                                return Control_Monad_State_Class.modify(Control_Monad_State_Trans.monadStateStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Perspectives_DomeinFile.addRolToDomeinFile($21));
                            }))(function () {
                                return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff))(Perspectives_RunMonadPerspectivesQuery.runTypedTripleGetterToObjects(Perspectives_ContextAndRole.context_id(ctxt))(Perspectives_DataTypeTripleGetters.iedereRolInContextM)))(function (v) {
                                    return Control_Bind.discard(Control_Bind.discardUnit)(Control_Monad_State_Trans.bindStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Data_Foldable.for_(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Data_Foldable.foldableArray)(v)(function (rolID) {
                                        return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff))(Perspectives_Resource.getPerspectEntiteit(Perspectives_PerspectEntiteit.perspectEntiteitRol)(rolID)))(function ($22) {
                                            return Control_Monad_State_Class.modify(Control_Monad_State_Trans.monadStateStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Perspectives_DomeinFile.addRolToDomeinFile($22));
                                        });
                                    }))(function () {
                                        return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(true);
                                    });
                                });
                            });
                        }));
                    };
                    return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(false);
                };
            };
            return Control_Bind.ifM(Control_Monad_State_Trans.bindStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(saveContext(c)(definedAtToplevel))(Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff))(Perspectives_RunMonadPerspectivesQuery.runTypedTripleGetterToObjects(Perspectives_ContextAndRole.context_id(c))(Perspectives_ModelBasedTripleGetters.boundContextsM)))(function (v) {
                return Data_Foldable.for_(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Data_Foldable.foldableArray)(v)(recursiveCollect);
            }))(Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Data_Unit.unit));
        };
    };
    return Control_Bind.bind(Control_Monad_Reader_Trans.bindReaderT(Control_Monad_Aff.bindAff))(Control_Monad_State_Trans.execStateT(Control_Monad_Reader_Trans.functorReaderT(Control_Monad_Aff.functorAff))(collect(enclosingContext)(false))(Perspectives_DomeinFile.defaultDomeinFile))(function (v) {
        return Control_Applicative.pure(Control_Monad_Reader_Trans.applicativeReaderT(Control_Monad_Aff.applicativeAff))(Perspectives_DomeinFile.DomeinFile((function () {
            var $18 = {};
            for (var $19 in v) {
                if ({}.hasOwnProperty.call(v, $19)) {
                    $18[$19] = v[$19];
                };
            };
            $18._rev = Perspectives_ContextAndRole.context_rev(enclosingContext);
            $18._id = Perspectives_ContextAndRole.context_id(enclosingContext);
            return $18;
        })()));
    });
};
module.exports = {
    domeinFileFromContext: domeinFileFromContext
};
