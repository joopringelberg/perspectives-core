// Generated by purs version 0.11.7
"use strict";
var $foreign = require("./foreign");
var Control_Applicative = require("../Control.Applicative");
var Control_Bind = require("../Control.Bind");
var Control_Monad_Aff = require("../Control.Monad.Aff");
var Control_Monad_Eff = require("../Control.Monad.Eff");
var Control_Monad_Eff_AVar = require("../Control.Monad.Eff.AVar");
var Control_Monad_Eff_Class = require("../Control.Monad.Eff.Class");
var Control_Monad_Reader_Trans = require("../Control.Monad.Reader.Trans");
var Control_Monad_State = require("../Control.Monad.State");
var Control_Monad_State_Trans = require("../Control.Monad.State.Trans");
var Control_Monad_Trans_Class = require("../Control.Monad.Trans.Class");
var Data_Function = require("../Data.Function");
var Data_Functor = require("../Data.Functor");
var Data_Maybe = require("../Data.Maybe");
var Data_Unit = require("../Data.Unit");
var Perspectives_CoreTypes = require("../Perspectives.CoreTypes");
var Perspectives_EntiteitAndRDFAliases = require("../Perspectives.EntiteitAndRDFAliases");
var Perspectives_GlobalUnsafeStrMap = require("../Perspectives.GlobalUnsafeStrMap");
var Perspectives_PerspectivesState = require("../Perspectives.PerspectivesState");
var Prelude = require("../Prelude");
var tripleIndex = Perspectives_GlobalUnsafeStrMap["new"](Data_Unit.unit);
var setMemorizeQueryResults = function (b) {
    return Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff))(Perspectives_PerspectivesState.modifyPerspectivesState(function (ps) {
        var $25 = {};
        for (var $26 in ps) {
            if ({}.hasOwnProperty.call(ps, $26)) {
                $25[$26] = ps[$26];
            };
        };
        $25.memorizeQueryResults = b;
        return $25;
    }));
};
var memorizeQueryResults = Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff))(Perspectives_PerspectivesState.getsPerspectivesState(function (v) {
    return v.memorizeQueryResults;
}));
var lookupInTripleIndex = function (rid) {
    return function (pid) {
        return function __do() {
            var v = Perspectives_GlobalUnsafeStrMap.peek(tripleIndex)(rid)();
            if (v instanceof Data_Maybe.Nothing) {
                return Data_Maybe.Nothing.value;
            };
            if (v instanceof Data_Maybe.Just) {
                var v1 = Perspectives_GlobalUnsafeStrMap.peek(v.value0)(pid)();
                if (v1 instanceof Data_Maybe.Nothing) {
                    return Data_Maybe.Nothing.value;
                };
                if (v1 instanceof Data_Maybe.Just) {
                    return new Data_Maybe.Just(v1.value0);
                };
                throw new Error("Failed pattern match at Perspectives.TripleAdministration line 57, column 7 - line 60, column 34: " + [ v1.constructor.name ]);
            };
            throw new Error("Failed pattern match at Perspectives.TripleAdministration line 52, column 3 - line 60, column 34: " + [ v.constructor.name ]);
        };
    };
};
var getTriple = function (v) {
    return lookupInTripleIndex(v.subject)(v.predicate);
};
var removeDependency = function (dependentRef) {
    return function (supportingRef) {
        return function __do() {
            var v = getTriple(supportingRef)();
            if (v instanceof Data_Maybe.Just) {
                return Data_Functor["void"](Control_Monad_Eff.functorEff)($foreign.removeDependency_(v.value0)(dependentRef))();
            };
            if (v instanceof Data_Maybe.Nothing) {
                return Data_Unit.unit;
            };
            throw new Error("Failed pattern match at Perspectives.TripleAdministration line 161, column 3 - line 163, column 21: " + [ v.constructor.name ]);
        };
    };
};
var getRef = function (v) {
    return {
        subject: v.subject,
        predicate: v.predicate
    };
};
var unRegisterTriple = function (v) {
    return function __do() {
        var v1 = Perspectives_GlobalUnsafeStrMap.peek(tripleIndex)(v.subject)();
        if (v1 instanceof Data_Maybe.Nothing) {
            return Data_Unit.unit;
        };
        if (v1 instanceof Data_Maybe.Just) {
            var v2 = Perspectives_GlobalUnsafeStrMap.peek(v1.value0)(v.predicate)();
            if (v2 instanceof Data_Maybe.Nothing) {
                return Data_Unit.unit;
            };
            if (v2 instanceof Data_Maybe.Just) {
                Data_Functor["void"](Control_Monad_Eff.functorEff)(Perspectives_GlobalUnsafeStrMap["delete"](v1.value0)(v.predicate))();
                return Control_Monad_Eff.foreachE(v2.value0.supports)(removeDependency(getRef(v2.value0)))();
            };
            throw new Error("Failed pattern match at Perspectives.TripleAdministration line 109, column 7 - line 114, column 58: " + [ v2.constructor.name ]);
        };
        throw new Error("Failed pattern match at Perspectives.TripleAdministration line 104, column 3 - line 114, column 58: " + [ v1.constructor.name ]);
    };
};
var ensureResource = function (rid) {
    return function __do() {
        var v = Perspectives_GlobalUnsafeStrMap.peek(tripleIndex)(rid)();
        if (v instanceof Data_Maybe.Nothing) {
            var v1 = Perspectives_GlobalUnsafeStrMap["new"](Data_Unit.unit);
            var v2 = Perspectives_GlobalUnsafeStrMap.poke(tripleIndex)(rid)(v1)();
            return v1;
        };
        if (v instanceof Data_Maybe.Just) {
            return v.value0;
        };
        throw new Error("Failed pattern match at Perspectives.TripleAdministration line 121, column 3 - line 126, column 23: " + [ v.constructor.name ]);
    };
};
var addDependency = function (dependentRef) {
    return function (supportingRef) {
        return function __do() {
            var v = getTriple(supportingRef)();
            if (v instanceof Data_Maybe.Just) {
                return Data_Functor["void"](Control_Monad_Eff.functorEff)($foreign.addDependency_(v.value0)(dependentRef))();
            };
            if (v instanceof Data_Maybe.Nothing) {
                return Data_Unit.unit;
            };
            throw new Error("Failed pattern match at Perspectives.TripleAdministration line 153, column 3 - line 155, column 25: " + [ v.constructor.name ]);
        };
    };
};
var addToTripleIndex = function (rid) {
    return function (pid) {
        return function (val) {
            return function (deps) {
                return function (sups) {
                    return function (tripleGetter) {
                        return function __do() {
                            var v = ensureResource(rid)();
                            var v1 = {
                                subject: rid,
                                predicate: pid,
                                object: val,
                                dependencies: deps,
                                supports: sups,
                                tripleGetter: tripleGetter
                            };
                            var v2 = Perspectives_GlobalUnsafeStrMap.poke(v)(pid)(v1)();
                            var v3 = Control_Monad_Eff.foreachE(sups)(addDependency(getRef(v1)))();
                            return v1;
                        };
                    };
                };
            };
        };
    };
};
var registerTriple = function (v) {
    return function __do() {
        var v1 = ensureResource(v.subject)();
        var v2 = Perspectives_GlobalUnsafeStrMap.poke(v1)(v.predicate)(v)();
        var v3 = Control_Monad_Eff.foreachE(v.supports)(addDependency(getRef(v)))();
        return v;
    };
};
var memorize = function (getter) {
    return function (name) {
        return new Perspectives_CoreTypes.TypedTripleGetter(name, function (id) {
            return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(memorizeQueryResults)(function (v) {
                if (v) {
                    return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff))(Control_Monad_Eff_Class.liftEff(Control_Monad_Reader_Trans.monadEffReader(Control_Monad_Aff.monadEffAff))(lookupInTripleIndex(id)(name))))(function (v1) {
                        if (v1 instanceof Data_Maybe.Nothing) {
                            return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(getter(id))(function (v2) {
                                return Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff))(Control_Monad_Eff_Class.liftEff(Control_Monad_Reader_Trans.monadEffReader(Control_Monad_Aff.monadEffAff))(registerTriple(v2)));
                            });
                        };
                        if (v1 instanceof Data_Maybe.Just) {
                            return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Aff.monadAff)))(v1.value0);
                        };
                        throw new Error("Failed pattern match at Perspectives.TripleAdministration line 135, column 9 - line 139, column 29: " + [ v1.constructor.name ]);
                    });
                };
                if (!v) {
                    return getter(id);
                };
                throw new Error("Failed pattern match at Perspectives.TripleAdministration line 132, column 5 - line 140, column 25: " + [ v.constructor.name ]);
            });
        });
    };
};
module.exports = {
    memorizeQueryResults: memorizeQueryResults,
    setMemorizeQueryResults: setMemorizeQueryResults,
    getRef: getRef,
    lookupInTripleIndex: lookupInTripleIndex,
    getTriple: getTriple,
    addToTripleIndex: addToTripleIndex,
    registerTriple: registerTriple,
    unRegisterTriple: unRegisterTriple,
    memorize: memorize,
    removeDependency_: $foreign.removeDependency_,
    setSupports_: $foreign.setSupports_
};
